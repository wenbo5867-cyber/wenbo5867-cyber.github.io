<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸Šä¼ è§†é¢‘ - å®éªŒå®¤</title>
  <link rel="stylesheet" href="CSS/OpenVideo.css">
</head>
<body>
  <div class="container">
    <h1>è¯·ä¸Šä¼ è§†é¢‘</h1>
    
    <div class="upload-section">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“</div>
        <p>ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
        <p class="file-info">æ”¯æŒMP4ã€AVIã€MOVç­‰æ ¼å¼</p>
        <input type="file" id="fileInput" accept="video/*" style="display: none;">
      </div>
      
      <button class="upload-btn" id="selectFileBtn">é€‰æ‹©è§†é¢‘æ–‡ä»¶</button>
    </div>
    
    <div class="status-section">
      <div class="upload-status" id="uploadStatus">
        <p>ç­‰å¾…ä¸Šä¼ ...</p>
      </div>
    </div>
    
    <div class="action-section">
      <button class="edit-btn" id="editVideoBtn" disabled>å‰ªè¾‘è§†é¢‘</button>
      <button class="test-btn" id="testBtn">æµ‹è¯•è¿æ¥</button>
    </div>
  </div>
  
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const editVideoBtn = document.getElementById('editVideoBtn');
    const testBtn = document.getElementById('testBtn');
    
    let uploadedVideo = null;
    let videoInfo = null;
    
    // æµ‹è¯•è¿æ¥æŒ‰é’®
    testBtn.addEventListener('click', function() {
      showStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
      
      fetch('http://localhost:5000/test')
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        throw new Error('è¿æ¥å¤±è´¥');
      })
      .then(data => {
        showStatus('è¿æ¥æˆåŠŸ: ' + data.message, 'success');
      })
      .catch(error => {
        showStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
      });
    });
    
    // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æŒ‰é’®
    selectFileBtn.addEventListener('click', function() {
      fileInput.click();
    });
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
    
    // æ–‡ä»¶é€‰æ‹©åå¤„ç†
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);
        handleFileUpload(file);
      }
    });
    
    // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function() {
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      
      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        console.log('æ‹–æ‹½çš„æ–‡ä»¶:', file);
        if (file.type.startsWith('video/')) {
          handleFileUpload(file);
        } else {
          showStatus('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼', 'error');
        }
      }
    });
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFileUpload(file) {
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('video/')) {
        showStatus('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼', 'error');
        return;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBä»¥å†…ï¼‰
      if (file.size > 50 * 1024 * 1024) {
        showStatus('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„è§†é¢‘æ–‡ä»¶ï¼', 'error');
        return;
      }
      
      uploadedVideo = file;
      
      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      showStatus(`æ–‡ä»¶å: ${file.name}<br>æ–‡ä»¶å¤§å°: ${(file.size / (1024 * 1024)).toFixed(2)} MB<br>æ–‡ä»¶ç±»å‹: ${file.type}`, 'info');
      
      // ä¸Šä¼ åˆ°Pythonåç«¯
      uploadToBackend(file);
    }
    
    // ä¸Šä¼ åˆ°Pythonåç«¯
function uploadToBackend(file) {
  showStatus('æ­£åœ¨ä¸Šä¼ è§†é¢‘åˆ°æœåŠ¡å™¨...', 'uploading');
  
  console.log('å‡†å¤‡ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:');
  console.log('- æ–‡ä»¶å:', file.name);
  console.log('- æ–‡ä»¶å¤§å°:', file.size, 'bytes');
  console.log('- æ–‡ä»¶ç±»å‹:', file.type);
  
  const formData = new FormData();
  formData.append('video', file);
  
  console.log('FormDataå†…å®¹:');
  for (let pair of formData.entries()) {
    console.log(pair[0] + ':', pair[1]);
  }
  
  fetch('http://127.0.0.1:5000/upload', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
    console.log('æœåŠ¡å™¨å“åº”å¤´:', [...response.headers.entries()]);
    return response.json();
  })
  .then(data => {
    console.log('æœåŠ¡å™¨å“åº”æ•°æ®:', data);
    if (data.error) {
      showStatus('ä¸Šä¼ å¤±è´¥: ' + data.error, 'error');
      return;
    }
    
    videoInfo = data;
    showStatus(`è§†é¢‘ä¸Šä¼ æˆåŠŸï¼<br>æ–‡ä»¶å: ${data.filename}<br>æ–‡ä»¶å¤§å°: ${(data.file_size / (1024 * 1024)).toFixed(2)} MB`, 'success');
    editVideoBtn.disabled = false;
  })
  .catch(error => {
    console.error('ä¸Šä¼ é”™è¯¯è¯¦æƒ…:', error);
    showStatus('ä¸Šä¼ å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯', 'error');
  });
}
    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message, status) {
      uploadStatus.innerHTML = `<p class="${status}">${message}</p>`;
      uploadStatus.className = 'upload-status ' + status;
    }
    
    // ä¿®æ”¹ editVideoBtn çš„ç‚¹å‡»äº‹ä»¶
    editVideoBtn.addEventListener('click', function() {
      if (videoInfo) {
        // å­˜å‚¨è§†é¢‘ä¿¡æ¯åˆ° sessionStorage
        sessionStorage.setItem('videoInfo', JSON.stringify(videoInfo));
        // è·³è½¬åˆ°è§†é¢‘å‰ªè¾‘é¡µé¢
        window.location.href = 'ClipVideo.html';
      }
    });
  });
</script>
</body>
</html>